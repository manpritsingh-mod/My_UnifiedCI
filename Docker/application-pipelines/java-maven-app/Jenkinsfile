/**
 * Enhanced Java Maven Template - Pulls pre-built images from Nexus
 * Usage: javaMaven_docker_template([maven_version: '3.8.6', run_tests: true])
 */
def call(Map config = [:]) {
    logger.info("üöÄ Starting Java Maven Pipeline with Nexus Docker Images")
    
    // Set defaults and add Docker configuration
    config = setupDockerConfig(config)
    def stageResults = [:]
    
    stage('Checkout') {
        script {
            logger.info("üì• CHECKOUT STAGE")
            core_github.checkout()
            stageResults['Checkout'] = 'SUCCESS'
        }
    }
    
    stage('Pull Maven Image from Nexus') {
        script {
            logger.info("üì¶ PULLING MAVEN IMAGE FROM NEXUS")
            
            def imagePath = "${config.nexus.registry}/${config.nexus.project}/maven:${config.maven_version}"
            logger.info("üîç Image: ${imagePath}")
            
            docker.withRegistry(config.nexus.url, config.nexus.credentials_id) {
                def image = docker.image(imagePath)
                
                logger.info("‚¨áÔ∏è Pulling image...")
                image.pull()
                
                // Verify image works
                image.inside {
                    sh 'mvn --version'
                    sh 'java -version'
                }
                
                logger.info("‚úÖ Maven image ready!")
            }
            
            env.MAVEN_DOCKER_IMAGE = imagePath
            stageResults['Pull Image'] = 'SUCCESS'
        }
    }
    
    stage('Setup Environment') {
        script {
            logger.info("üîß SETUP ENVIRONMENT")
            core_utils.setupProjectEnvironment(config.project_language, config)
            stageResults['Setup'] = 'SUCCESS'
        }
    }
    
    stage('Install Dependencies') {
        script {
            logger.info("üì¶ INSTALL DEPENDENCIES IN CONTAINER")
            
            docker.withRegistry(config.nexus.url, config.nexus.credentials_id) {
                def image = docker.image(env.MAVEN_DOCKER_IMAGE)
                
                image.inside("-v ${WORKSPACE}:/workspace -w /workspace") {
                    logger.info("üîß Installing Maven dependencies...")
                    sh 'mvn dependency:resolve -B'
                    sh 'mvn dependency:resolve-sources -B'
                    logger.info("‚úÖ Dependencies installed successfully")
                }
            }
            
            stageResults['Install Dependencies'] = 'SUCCESS'
        }
    }
    
    stage('Lint') {
        if (core_utils.shouldExecuteStage('lint', config)) {
            script {
                logger.info("üîç LINTING IN CONTAINER")
                
                def lintResult = runLintInContainer(config)
                env.LINT_RESULT = lintResult
                stageResults['Lint'] = lintResult
                logger.info("Lint completed with result: ${lintResult}")
            }
        } else {
            script {
                logger.info("Linting is disabled - skipping")
                env.LINT_RESULT = 'SKIPPED'
                stageResults['Lint'] = 'SKIPPED'
            }
        }
    }
    
    stage('Build') {
        script {
            logger.info("üî® BUILDING IN CONTAINER")
            
            docker.withRegistry(config.nexus.url, config.nexus.credentials_id) {
                def image = docker.image(env.MAVEN_DOCKER_IMAGE)
                
                image.inside("-v ${WORKSPACE}:/workspace -w /workspace") {
                    logger.info("üèóÔ∏è Building Maven project...")
                    sh 'mvn clean compile -B'
                    sh 'mvn package -DskipTests -B'
                    
                    // Archive artifacts
                    if (fileExists('target/*.jar')) {
                        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                        logger.info("üì¶ JAR artifacts archived")
                    }
                    
                    logger.info("‚úÖ Build completed successfully")
                }
            }
            
            stageResults['Build'] = 'SUCCESS'
        }
    }
    
    stage('Test Execution') {
        script {
            def parallelTests = [:]
            
            // Unit Tests
            if (core_utils.shouldExecuteStage('unittest', config)) {
                parallelTests['Unit Test'] = {
                    logger.info("üß™ Running Unit Tests in Container")
                    def testResult = runUnitTestsInContainer(config)
                    env.UNIT_TEST_RESULT = testResult
                    stageResults['Unit Test'] = testResult
                    logger.info("Unit tests completed with result: ${testResult}")
                }
            } else {
                env.UNIT_TEST_RESULT = 'SKIPPED'
                stageResults['Unit Test'] = 'SKIPPED'
            }
            
            // Functional Tests
            if (core_utils.shouldExecuteStage('functionaltest', config)) {
                parallelTests['Functional Tests'] = {
                    runFunctionalTestsInContainer(config, stageResults)
                }
            } else {
                env.FUNCTIONAL_TEST_RESULT = 'SKIPPED'
                stageResults['Functional Tests'] = 'SKIPPED'
            }
            
            // Execute parallel tests
            if (parallelTests.size() > 0) {
                parallel parallelTests
            } else {
                logger.info("No tests enabled - skipping test execution")
            }
        }
    }
    
    stage('Generate Reports') {
        script {
            logger.info("üìä GENERATE REPORTS STAGE")
            sendReport.generateAndSendReports(config, stageResults)
            stageResults['Generate Reports'] = 'SUCCESS'
        }
    }
}

// Helper Methods
private def setupDockerConfig(Map config) {
    // Set defaults
    if (!config.project_language) {
        config.project_language = 'java-maven'
    }
    
    // Docker/Nexus configuration
    if (!config.nexus) {
        config.nexus = [:]
    }
    config.nexus.url = config.nexus.url ?: env.NEXUS_REGISTRY_URL ?: 'https://nexus.company.com:8082'
    config.nexus.registry = config.nexus.registry ?: 'nexus.company.com:8082'
    config.nexus.project = config.nexus.project ?: 'dev'
    config.nexus.credentials_id = config.nexus.credentials_id ?: 'nexus-docker-creds'
    
    // Maven version
    config.maven_version = config.maven_version ?: '3.8.6'
    
    // Test configuration
    if (!config.tool_for_unit_testing) {
        config.tool_for_unit_testing = [java: 'junit']
    }
    if (!config.tool_for_lint_testing) {
        config.tool_for_lint_testing = [java: 'checkstyle']
    }
    
    // Stage execution flags
    if (config.runUnitTests == null) config.runUnitTests = true
    if (config.runLintTests == null) config.runLintTests = true
    if (config.runFunctionalTests == null) config.runFunctionalTests = true
    
    return config
}

private def runLintInContainer(Map config) {
    return docker.withRegistry(config.nexus.url, config.nexus.credentials_id) {
        def image = docker.image(env.MAVEN_DOCKER_IMAGE)
        
        return image.inside("-v ${WORKSPACE}:/workspace -w /workspace") {
            try {
                def lintTool = config.tool_for_lint_testing.java
                logger.info("üßπ Running ${lintTool}...")
                sh "mvn ${lintTool}:check -B"
                return 'SUCCESS'
            } catch (Exception e) {
                logger.warning("‚ö†Ô∏è Lint found violations: ${e.getMessage()}")
                return 'UNSTABLE'
            }
        }
    }
}

private def runUnitTestsInContainer(Map config) {
    return docker.withRegistry(config.nexus.url, config.nexus.credentials_id) {
        def image = docker.image(env.MAVEN_DOCKER_IMAGE)
        
        return image.inside("-v ${WORKSPACE}:/workspace -w /workspace") {
            try {
                logger.info("üèÉ Running unit tests...")
                sh 'mvn test -B'
                
                // Publish test results
                if (fileExists('target/surefire-reports/*.xml')) {
                    publishTestResults testResultsPattern: 'target/surefire-reports/*.xml'
                }
                
                return 'SUCCESS'
            } catch (Exception e) {
                logger.warning("‚ö†Ô∏è Some unit tests failed: ${e.getMessage()}")
                return 'UNSTABLE'
            }
        }
    }
}

private def runFunctionalTestsInContainer(Map config, Map stageResults) {
    docker.withRegistry(config.nexus.url, config.nexus.credentials_id) {
        def image = docker.image(env.MAVEN_DOCKER_IMAGE)
        
        image.inside("-v ${WORKSPACE}:/workspace -w /workspace") {
            // Smoke Tests
            stage('Smoke Tests') {
                if (core_utils.shouldExecuteStage('smoketest', config)) {
                    logger.info("üí® Running Smoke Tests...")
                    sh 'mvn test -Psmoke -B'
                    stageResults['Smoke Tests'] = 'SUCCESS'
                } else {
                    stageResults['Smoke Tests'] = 'SKIPPED'
                }
            }
            
            // Sanity Tests
            stage('Sanity Tests') {
                if (core_utils.shouldExecuteStage('sanitytest', config)) {
                    logger.info("üß† Running Sanity Tests...")
                    sh 'mvn test -Psanity -B'
                    stageResults['Sanity Tests'] = 'SUCCESS'
                } else {
                    stageResults['Sanity Tests'] = 'SKIPPED'
                }
            }
            
            // Regression Tests
            stage('Regression Tests') {
                if (core_utils.shouldExecuteStage('regressiontest', config)) {
                    logger.info("üîÑ Running Regression Tests...")
                    sh 'mvn test -Pregression -B'
                    stageResults['Regression Tests'] = 'SUCCESS'
                } else {
                    stageResults['Regression Tests'] = 'SKIPPED'
                }
            }
        }
    }
    
    env.FUNCTIONAL_TEST_RESULT = 'SUCCESS'
}
